# Longhorn 开发任务 backlog

> **最后更新**: 2026-02-24
> **版本**: 1.3.2

---

## 进行中任务

### [UI-001] Wiki & Bokeh UI 抛光 (已完成)
- [x] 过滤相关引用，仅显示知识库文章
- [x] Wiki "查看更多" 按钮颜色调整为淡灰色
- [x] "操作首选项" 重命名为 "操作"
- [x] 修复工单卡片 `null` 名称显示
- [x] Bokeh 气泡颜色调整 (User: Kine Green, Bokeh: Gray)
- [x] Bokeh 引用图标优化 (Wiki: Book, Ticket: Ticket)
- [x] SVC 工单特殊显示逻辑 (Dealer Name)
- [x] Bokeh AI聊天气泡样式：移除绿框，修复Markdown列表缩进对齐及普通文本的一致性。
- [x] 搜寻和右面板展示优化：隐藏文章分类和产品线间的特殊符号，统一所有TicketCard分隔符为点(·)样式并对状态增加多语言映射，拓宽搜索框组件 (input)。
- [x] 账户与联络人管理 (CRM编辑弹框)：修复在 Account & Dealer 编辑中设定某人为Prime联系人并保存时由于并发请求引发的 `Operation failed` (SQLite table lock) 。
- [x] Wiki 状态持久化 (State Persistence)：实现 `useWikiStore` 进行 LocalStorage 存取，切换菜单也能找回原来的 Wiki Tab 和搜索记录。
- [x] Ticket Lists 搜索框状态：支持搜索词保留及展开状态感知。
- [x] Kinefinity Wiki 的搜索历史下拉框：改为了右对齐（Right-aligned）修复视效偏移。
- [x] CustomerFormModal 窗口优化：设定弹窗固定宽度和高度边界避免由 Tab 标签切换带来的视窗跳跃干扰，增加对于添加主要联系人的指导文字。)

---

## 📅 最近更新历史 (From 1_Backlog.md)

### 2026-02-24 (Session 4)
- **知识库导入优化与网页抓取修复 (v1.3.4)**:
    - **网页抓取引擎升级**: 实现了基于 H1/H2 的自动章节切分转换逻辑，支持 Turbo (Markdown) 和 Standard (HTML) 模式下的长网页结构化导入。
    - **UI 视觉细节调优**: 修复了产品型号选中后的文字颜色对比度问题（灰色 -> 白色）。
    - **进度交互优化**: 根据导入模式动态切换进度文字（Hidden: Upload step for URL import）。
    - **品牌一致性**: 将导入完成按钮颜色统合为 Kine Green (#00A650)。
    - **内容渲染净化**: 后端自动剥离硬编码的白底样式，确保网页内容在深窗主题下的融合度。

### 2026-02-24 (Session 3)
- **详情页布局与导航模块化标准化 (v12.1.31)**:
    - **黑屏问题根治**: 识别并修复了 `Inquiry`, `RMA`, `DealerRepair` 详情页中的 `100vh` 布局冲突，彻底解决了嵌套于 `MainLayout` 时出现的显示异常。
    - **全站单页导航对齐**: 将 Wiki 系统的外部跳转逻辑统一收敛为 SPA 内部 `navigate` 模式，规避了状态丢失风险。
    - **资产联动闭环**: 补全了客户详情页中设备卡片的点击事件，实现了直接关联至技术支持库（Wiki）的功能。

### 2026-02-24 (Session 2)
- **CustomerDetailPage 响应式与逻辑优化 (v12.1.30)**:
    - **自适应布局组件化**: 成功应用 `auto-fill` 网格策略于 Dashboard 和设备资产模块，解决了视窗缩放时的卡片溢出。
    - **全量 UI 汉化**: 剥离了 Dashboard 统计项与设备资产分类中的硬编码字符，并利用 `tc()` 助手修复了 TS 校验报错。
    - **SVC 场景化交互**: 实现了维修工单在 Dealer/Customer 页面下的“对侧实体”展示逻辑，信息流更加清晰。
    - **CRM 核心逻辑加固**: 修复了 `contacts.js` 在处理主要联系人状态切换时的覆盖 Bug。
    - **设备卡片视觉重构**: 上线了横向 Pill 样式的 `ProductCard`。

### 2026-02-24 (Session 1)
- **Bokeh 知识检索与格式化修复 (v12.1.28)**:
    - 修复 `ai_service.js` 中知识库检索的 FTS 表名及 `LIKE` 兜底丢失问题。
    - 将 AI 工单 Prompt 上下文补齐 `contact_name`。
    - 修复了工单卡片联系人的前缀冗余与分隔符（从 `·` 改为 `|`）。
- **Bokeh UI 与搜索深度优化**:
    - **知识库 RAG 增强**: 将知识库检索逻辑从严格匹配优化为宽泛关键词匹配，解决 AI 无法拉取相关知识的问题。
    - **交互链路优化**: 对话卡片（工单/文章）点击改为新标签页打开，移除本地 Dialog 冗余代码。
    - **工单显示精简**: 实现了工单卡片的姓名去重逻辑，确保 SVC 工单与普通工单信息展示更专业。
    - **自动化发布**: 成功执行 V12.1.27 版本的自动化构建与远程部署。
- **Bokeh UI 与搜索优化**:
    - 将用户消息气泡背景改为 Kine Green (`#4CAF50`)，助手气泡改为灰色。
    - 修复了 SQL 拼接逻辑中缺失 `1=1` 导致的搜索稳健性问题。
    - 优化了技术词汇（SDI/HDMI）在 FTS5 环境下的命中率。
    - 针对 SVC- 工单，实现了经销商账户名称的精准显示与“经销商:”标识。
- **知识导入工具深度优化**: 
    - 修复了 URL 导入 (Turbo 模式) 的变量作用域 Bug。
    - 实现了产品型号的**多选标签**交互。
    - 重构进度面板摘要为叙述性文字描述（macOS26 风格）。

### 2026-02-23
- **Admin 设置体验升级**: 将所有管理端原生 `alert` 替换为响应式 `toast` 通知（Kine Yellow 风格）。
- **每日一词可见性修复**: 取消了公共设置接口 `/public-settings` 的鉴权要求。
- **Wiki 导入样式统一**: 细化了知识生成器中“Bokeh 优化”按钮的选中态。
- **搜索 Tab 视觉分离**: 利用 `flex: 1` 占位符将搜索历史 Tab 强制推至 Tab 栏的最右侧。
- **Admin 设置状态持久化**: 实现了 Admin 面板的二级路由记忆功能。
- **全量设置存入 DB**: 彻底迁移了「显示每日一词徽章」等配置至 `system_settings` 数据库。

### 2026-02-22
- **知识库UI对齐完善**: 删除了 `1.1.1` 冗余前缀章节号渲染 Bug，重构了 Manual TOC Modal。
- **知识库导入与本地服务修复**: 解决了因硬编码 `/Volumes/fileserver` 导致的 Node 崩溃。

### 2026-02-21
- **搜索质量提升**: 实现多关键词 AND 拆分搜索。
- **全量字段对齐**: 完成全栈 `customer_id` -> `account_id` 迁移。
- **搜索范围重大突破**: 彻底解除“仅搜已关闭工单”限制。
- **知识库 (Phase 2) 标记完成**: 全方位文档同步 (PRD, API, DataModel, Scenarios)。

---

## 📋 待办任务

### [DEALER-001] 经销商停用功能完善
**状态**: ⬜ 待开发  
**优先级**: P2  
**计划**:
1. 停用时禁止关联用户登录
2. 停用前检查API（展示风险项）
3. 库存处理策略（冻结/转移）

### [SYSTEM-001] 全局权限与安全审计
- 细化 `Employee` 与 `Market` 角色的权限边界。
- 完善所有数据导出操作的审计日志。

---

## ✅ 已完成任务 (历史记录)

### [WIKI-001] Wiki 主界面重新设计 + Bokeh AI 融合 (2026-02-15)
### [WIKI-002] 知识导入交互与稳定性改进 (2026-02-24)
### [INV-001] 经销商备件库存管理 + 经销商维修工单集成 (2026-02-15)
### [WIKI-000] 清空知识库数据 (2026-02-17)

---

## 任务编号规范
- `WIKI-xxx`: Wiki/知识库相关
- `TICKET-xxx`: 工单系统相关
- `BOKEH-xxx`: Bokeh AI 相关
- `UI-xxx`: 界面设计相关
- `API-xxx`: 后端接口相关
- `INV-xxx`: 库存管理相关
- `DEALER-xxx`: 经销商管理相关
